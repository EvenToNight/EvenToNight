openapi: 3.0.1
info:
  title: EvenToNight - Users API
  version: 1.0.0

tags:
  - name: Auth
    description: Authentication and token management
  - name: Users
    description: User management

paths:

  /login:
    post:
      tags: [Auth]
      summary: Login user
      description: Authenticates a user using username/email and password.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidLogin'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponseDTO'
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
              examples:
                invalidJson:
                  value: Invalid JSON
                invalidRequest:
                  value: Invalid login request
        '401':
          description: Invalid credentials
          content:
            text/plain:
              schema:
                type: string
              examples:
                invalidCredentials:
                  value: 'Login failed: invalid credentials'
        '403':
          description: Client not allowed
          content:
            text/plain:
              schema:
                type: string
              examples:
                clientNotAllowed:
                  value: 'Login failed: client not allowed'
        '404':
          description: User not found in database
          content:
            text/plain:
              schema:
                type: string
              examples:
                userNotFound:
                  value: User not found
        '500':
          description: Internal server error
          content:
            text/plain:
              schema:
                type: string
              examples:
                loginServiceError:
                  value: Login failed
                tokenVerificationError:
                  value: Failed to verify token
                tokenExtractionError:
                  value: Failed to extract user identifier

  /register:
    post:
      tags: [Auth]
      summary: Register user
      description: >
        Registers a new user and logs them in.
        On successful registration, a UserCreated domain event is published.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidRegistration'
      responses:
        '201':
          description: User created and logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponseDTO'
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
              examples:
                invalidJson:
                  value: Invalid JSON
                invalidRequest:
                  value: Invalid registration request
                passwordNotCompliant:
                  value: Password does not meet requirements
                userCreationRejected:
                  value: User creation rejected
        '500':
          description: Internal server error
          content:
            text/plain:
              schema:
                type: string
              examples:
                registrationServiceError:
                  value: Failed to create user
                loginAfterCreationFailed:
                  value: User created but login failed

  /refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      description: Refreshes access and refresh tokens.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Tokens refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokensDTO'
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
              examples:
                invalidJson:
                  value: Invalid JSON
        '401':
          description: Invalid refresh token
          content:
            text/plain:
              schema:
                type: string
              examples:
                tokenRefreshError:
                  value: Token refresh failed

  /logout:
    post:
      tags: [Auth]
      summary: Logout user
      description: Invalidates a refresh token.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
      responses:
        '204':
          description: Logout successful
        '400':
          description: Bad request
          content:
            text/plain:
              schema:
                type: string
              examples:
                invalidJson:
                  value: Invalid JSON
        '500':
          description: Logout failed
          content:
              text/plain:
                schema:
                  type: string
                examples:
                  logoutServiceError:
                    value: Logout failed

  /public-keys:
    get:
      tags: [Auth]
      summary: Get public keys
      description: Returns public keys used to verify JWT tokens.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
        - url: https://users.eventonight.site
          description: Users service (production)
      responses:
        '200':
          description: Public keys retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicKeysResponse'
        '500':
          description: Failed to refresh public keys
          content:
            text/plain:
              schema:
                type: string
              examples:
                refreshError:
                  value: Failed to refresh public keys

  /{userId}:
    get:
      tags: [Users]
      summary: Get user by ID
      description: >
        Returns the user corresponding to the ID.

        - If the request contains a valid token with the user_id claim matching the userId in the path, 
          the response includes id, role, full account and profile.  
        - Otherwise, only id, role, username and profile are returned.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
        - url: https://users.eventonight.site
          description: Users service (production)
      security:
        - bearerAuth: []      
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                oneOf:
                  # ---------- OWNER ----------
                  - type: object
                    required:
                      - id
                      - role
                      - account
                      - profile
                    properties:
                      id:
                        type: string
                        format: uuid
                        example: "123e4567-e89b-12d3-a456-426614174000"
                      role:
                        type: string
                        example: member
                      account:
                        $ref: '#/components/schemas/AccountDTO'
                      profile:
                        $ref: '#/components/schemas/ProfileDTO'
                  # ---------- NON OWNER ----------
                  - $ref: '#/components/schemas/UserDTO'
              examples:
                ownerExample:
                  summary: Owner full view
                  value:
                    id: "123e4567-e89b-12d3-a456-426614174000"
                    role: member
                    account:
                      username: johndoe
                      email: johndoe@example.com
                      darkMode: true
                      language: en
                    profile:
                      name: John Doe
                      avatar: https://example.com/avatar.png
                      bio: Software developer and event enthusiast.
                nonOwnerExample:
                  summary: Public view
                  value:
                    id: "123e4567-e89b-12d3-a456-426614174000"
                    role: member
                    account:
                      username: johndoe
                    profile:
                      name: John Doe
                      avatar: https://example.com/avatar.png
                      bio: Software developer and event enthusiast.
        '404':
          description: User not found
          content:
            text/plain:
              schema:
                type: string
              examples:
                databaseError:
                  value: User not found

    delete:
      tags: [Users]
      summary: Delete user by ID
      description: >
        Deletes the authenticated user.
        The userId in the path must match the user_id claim in the access token.
        On successful deletion, a UserDeleted domain event is published.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
        - url: https://users.eventonight.site
          description: Users service (production)
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the user to delete
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: User successfully deleted
        '400':
          description: Bad request, validation or authorization error
          content:
            text/plain:
              schema:
                type: string
              examples:
                genericError:
                  summary: Any error
                  value: "Bad request or authorization failed"

    put:
      tags: [Users]
      summary: Update user by ID
      description: >
        Updates the authenticated user's account and profile information.
        The userId in the path must match the user_id claim in the access token.
        All fields provided in the request body replace the current values.
        Optional fields not included will be cleared.
        On success, a UserUpdated domain event is published.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
        - url: https://users.eventonight.site
          description: Users service (production)
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the user to update
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequestDTO'
      responses:
        '204':
          description: User successfully updated
        '400':
          description: Bad request or validation error
          content:
            text/plain:
              schema:
                type: string
              examples:
                invalidPayload:
                  summary: Invalid update payload
                  value: "Invalid update request"
        '404':
          description: User not found
          content:
            text/plain:
              schema:
                type: string
              examples:
                databaseError:
                  value: User not found

  /{userId}/avatar:
    post:
      tags: [Users]
      summary: Update user avatar by ID
      description: >
        Updates the avatar of the authenticated user corresponding to the ID.
        The userId in the path must match the user_id claim in the access token.
        On success, returns the URL of the uploaded avatar.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the user whose avatar will be updated
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                avatar:
                  type: string
                  format: binary
                  description: The new avatar image file
      responses:
        '200':
          description: Avatar updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvatarResponseDTO'
              examples:
                success:
                  summary: Avatar URL returned
                  value:
                    avatarUrl: "https://media.eventonight.site/users/1234/avatar.jpg"
        '400':
          description: Failed to update user avatar
          content:
            text/plain:
              schema:
                type: string
              examples:
                updateFailed:
                  summary: Update failed
                  value: "Failed to update user avatar"
        '401':
          description: Unauthorized
          content:
            text/plain:
              schema:
                type: string
              examples:
                unauthorized:
                  summary: No token or not authorized
                  value: "Unauthorized: invalid or missing token"
        '404':
          description: User not found
          content:
            text/plain:
              schema:
                type: string
              examples:
                notFound:
                  summary: User does not exist
                  value: "User not found"
    
    delete:
      tags: [Users]
      summary: Delete user avatar by ID
      description: >
        Deletes the avatar of the authenticated user.
        The userId in the path must match the user_id claim in the access token.
        The avatar is reset to the default image.
        On success, a UserUpdated domain event is published.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
        - url: https://users.eventonight.site
          description: Users service (production)
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the user whose avatar will be deleted
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Avatar successfully deleted and reset to default
        '400':
          description: Bad request or update failed
          content:
            text/plain:
              schema:
                type: string
              examples:
                updateFailed:
                  summary: Avatar update failed
                  value: "Failed to update user avatar"

  /{userId}/password:
    put:
      tags: [Users]
      summary: Update user password by ID
      description: >
        Updates the authenticated user's password.
        The current password must be provided and correct.
        The new password must match the confirm password field.
        The userId in the path must match the user_id claim in the access token.

      servers:
        - url: http://localhost:9000
          description: Users service (local development)
        - url: https://users.eventonight.site
          description: Users service (production)
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the user whose password will be updated
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePasswordRequestDTO'
      responses:
        '204':
          description: Password updated successfully
        '400':
          description: Invalid request or password update failed

  /search:
    get:
      tags: [Users]
      summary: Search and filter users
      description: >
        Searches for users by role and/or username/profile name prefix.
        Returns users matching the criteria in pages of results.
        If no query parameters are specified, the first 10 users are returned.
      servers:
        - url: http://localhost:9000
          description: Users service (local development)
        - url: https://users.eventonight.site
          description: Users service (production)
      parameters:
        - name: role
          in: query
          description: Filter by role ("member" or "organization")
          required: false
          schema:
            $ref: '#/components/schemas/SearchUsersQueryDTO/properties/role'
        - name: prefix
          in: query
          description: Filter users whose username or profile name starts with this prefix (case-insensitive)
          required: false
          schema:
            $ref: '#/components/schemas/SearchUsersQueryDTO/properties/prefix'
        - name: limit
          in: query
          description: Maximum number of users to return (default 10, max 20)
          required: false
          schema:
            $ref: '#/components/schemas/SearchUsersQueryDTO/properties/limit'
        - name: offset
          in: query
          description: Number of users to skip for pagination (default 0)
          required: false
          schema:
            $ref: '#/components/schemas/SearchUsersQueryDTO/properties/offset'
      responses:
        '200':
          description: Successfully retrieved filtered users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedUserSearchResponse'
        '400':
          description: Invalid query parameters
          content:
            text/plain:
              schema:
                type: string
              examples:
                invalidRole:
                  summary: Role not valid
                  value: "Invalid role: admin"
                negativeLimit:
                  summary: Limit not positive
                  value: "Limit must be positive, got -5"
                negativeOffset:
                  summary: Offset not valid
                  value: "Offset must be non-negative, got -3"
        '500':
          description: Internal server error
          content:
            text/plain:
              schema:
                type: string
              examples:
                genericError:
                  summary: Unexpected server error
                  value: "Internal server error while searching users"

components:
  schemas:

    ValidLogin:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: johndoe
        password:
          type: string
          format: password
          example: StrongP@ssw0rd!

    ValidRegistration:
      type: object
      required:
        - username
        - email
        - password
        - role
      properties:
        username:
          type: string
          example: johndoe
        email:
          type: string
          example: johndoe@example.com
        password:
          type: string
          format: password
          example: StrongP@ssw0rd!
        role:
          type: string
          example: member

    RefreshRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          example: dGhpcy1pcz1hLXJlZnJlc2gtdG9rZW4uLi4=

    LogoutRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          example: dGhpcy1pcz1hLXJlZnJlc2gtdG9rZW4uLi4=

    TokensDTO:
      type: object
      required:
        - accessToken
        - expiresIn
        - refreshToken
        - refreshExpiresIn
      properties:
        accessToken:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expiresIn:
          type: integer
          format: int64
          example: 300
        refreshToken:
          type: string
          example: dGhpcy1pcz1hLXJlZnJlc2gtdG9rZW4uLi4=
        refreshExpiresIn:
          type: integer
          format: int64
          example: 1800

    AccountDTO:
      type: object
      required:
        - username
        - email
        - darkMode
        - language
      properties:
        username:
          type: string
          example: johndoe
        email:
          type: string
          example: johndoe@example
        darkMode:
          type: boolean
          example: false
        language:
          type: string
          example: en
        gender:
          type: string
          nullable: true
          example: male
        birthDate:
          type: string
          format: date-time
          nullable: true
          example: 1990-01-01T00:00:00Z
        interests:
          type: array
          items:
            type: string
          nullable: true
          example: ["Dinner", "Live Music", "Club"]

    ProfileDTO:
      type: object
      required:
        - name
        - avatar
      properties:
        name:
          type: string
          example: John Doe
        avatar:
          type: string
          example: https://example.com/avatar.jpg
        bio:
          type: string
          nullable: true
          example: Software developer and event enthusiast.
        contacts:
          type: array
          items:
            type: string
            format: uri
            pattern: "^https?://.*"
          nullable: true
          example:
            - https://twitter.com/johndoe
            - https://linkedin.com/in/johndoe

    LoginResponseDTO:
      type: object
      required:
        - id
        - role
        - account
        - profile
        - accessToken
        - expiresIn
        - refreshToken
        - refreshExpiresIn
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        role:
          type: string
          example: member
        account:
          $ref: '#/components/schemas/AccountDTO'
        profile:
          $ref: '#/components/schemas/ProfileDTO'
        accessToken:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expiresIn:
          type: integer
          format: int64
          example: 300
        refreshToken:
          type: string
          example: dGhpcy1pcz1hLXJlZnJlc2gtdG9rZW4uLi4=
        refreshExpiresIn:
          type: integer
          format: int64
          example: 1800

    UsernameDTO:
      type: object
      required:
        - username
      properties:
        username:
          type: string
          example: johndoe

    UserDTO:
      type: object
      required:
        - id
        - role
        - account
        - profile
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        role:
          type: string
          example: member
        account:
          $ref: '#/components/schemas/UsernameDTO'        
        profile:
          $ref: '#/components/schemas/ProfileDTO'
    
    PublicKeyEntry:
      type: object
      required:
        - kid
        - publicKey
      properties:
        kid:
          type: string
          example: key-id-12345
        publicKey:
          type: string
          description: Base64-encoded public key
          example: LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS1cbk1J...

    PublicKeysResponse:
      type: object
      required:
        - keys
      properties:
        keys:
          type: array
          items:
            $ref: '#/components/schemas/PublicKeyEntry'

    UpdateUserRequestDTO:
      type: object
      description: Update request for a user.
      properties:
        accountDTO:
          $ref: '#/components/schemas/UpdateAccountDTO'
        profileDTO:
          $ref: '#/components/schemas/UpdateProfileDTO'

    UpdateAccountDTO:
      type: object
      description: Update request of user account information.
      properties:
        darkMode:
          type: boolean
          example: true
        language:
          type: string
          example: it
        gender:
          type: string
          nullable: true
          example: male
        birthDate:
          type: string
          format: date-time
          nullable: true
          example: 1990-01-01T00:00:00Z
        interests:
          type: array
          items:
            type: string
          nullable: true
          example: ["Dinner", "Live Music", "Club"]

    UpdateProfileDTO:
      type: object
      description: Update request of user profile information.
      properties:
        name:
          type: string
          example: John Doe
        bio:
          type: string
          nullable: true
          example: Software developer and event enthusiast.
        contacts:
          type: array
          items:
            type: string
            format: uri
            pattern: "^https?://.*"
          nullable: true
          example:
            - https://twitter.com/johndoe
            - https://linkedin.com/in/johndoe

    AvatarResponseDTO:
      type: object
      required:
        - userId
        - avatarUrl
      properties:
        userId:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        avatarUrl:
          type: string
          example: "https://media.eventonight.site/users/123e4567-e89b-12d3-a456-426614174000/avatar.jpg"

    UpdatePasswordRequestDTO:
      type: object
      required:
        - currentPassword
        - newPassword
        - confirmPassword
      properties:
        currentPassword:
          type: string
          format: password
          example: "OldP@ssw0rd!"
        newPassword:
          type: string
          format: password
          example: "NewStr0ngP@ss!"
        confirmPassword:
          type: string
          format: password
          example: "NewStr0ngP@ss!"

    SearchUsersQueryDTO:
      type: object
      description: Parameters used to filter/search users
      properties:
        role:
          type: string
          enum: [member, organization]
          description: Filter users by role
        prefix:
          type: string
          description: Filter users whose username or profile name starts with this prefix (case-insensitive)
        limit:
          type: integer
          default: 10
          maximum: 20
          description: Maximum number of users to return (default 10, max 20)
        offset:
          type: integer
          default: 0
          minimum: 0
          description: Number of users to skip for pagination (default 0)
          
    UserSearchAccountResult:
      type: object
      description: Account-related data returned in user search results
      required:
        - username
      properties:
        username:
          type: string
          description: The user's unique username
          example: johndoe

    UserSearchProfileResult:
      type: object
      description: Profile-related data returned in user search results
      required:
        - name
        - avatar
        - bio
      properties:
        name:
          type: string
          description: The profile name of the user
          example: John Doe
        avatar:
          type: string
          description: URL to the user's avatar image
          example: https://example.com/avatar.jpg
        bio:
          type: string
          description: Short biography or description of the user
          nullable: true
          example: Software developer and event enthusiast.

    UserSearchResult:
      type: object
      description: Represents a single user returned in search results
      required:
        - id
        - role
        - account
        - profile
      properties:
        id:
          type: string
          description: The user's unique ID
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        role:
          type: string
          description: Role of the user, either "member" or "organization"
          enum: [member, organization]
          example: member
        account:
          $ref: '#/components/schemas/UserSearchAccountResult'
        profile:
          $ref: '#/components/schemas/UserSearchProfileResult'

    PaginatedUserSearchResponse:
      type: object
      description: Paginated response for user search
      required:
        - data
        - limit
        - offset
        - hasMore
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/UserSearchResult'
        limit:
          type: integer
          example: 20
        offset:
          type: integer
          example: 0
        hasMore:
          type: boolean
          example: true

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
