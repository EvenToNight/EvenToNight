asyncapi: "2.5.0"

info:
  title: Events Service Async API
  version: "1.0.0"
  description: >
    AsyncAPI specification for domain events published by the Events service.
    The service publishes and consumes events to the central RabbitMQ exchange `eventonight`.

servers:
  rabbitmq:
    url: amqp://localhost:5672
    protocol: amqp
    description: RabbitMQ broker used by the Events Service to publish domain events related to events managed on the website.

channels:
  eventonight:
    description: Domain events exchange
    bindings:
      amqp:
        is: routingKey
        exchange:
          name: eventonight
          type: topic
          durable: true

    subscribe:
      operationId: onDomainEvent
      message:
        oneOf:
          - $ref: "#/components/messages/EventPublishedMessage"
          - $ref: "#/components/messages/EventUpdatedMessage"
          - $ref: "#/components/messages/EventDeletedMessage"

components:
  messages:
    EventPublishedMessage:
      name: EventPublished
      title: Event Published
      contentType: application/json
      bindings:
        amqp:
          routingKey: event.published
      headers:
        $ref: "#/components/schemas/EventHeaders"
      payload:
        $ref: "#/components/schemas/EventPublished"

    EventUpdatedMessage:
      name: EventUpdated
      title: Event Updated
      contentType: application/json
      bindings:
        amqp:
          routingKey: event.updated
      headers:
        $ref: "#/components/schemas/EventHeaders"
      payload:
        $ref: "#/components/schemas/EventUpdated"

    EventDeletedMessage:
      name: EventDeleted
      title: Event Deleted
      contentType: application/json
      bindings:
        amqp:
          routingKey: event.deleted
      headers:
        $ref: "#/components/schemas/EventHeaders"
      payload:
        $ref: "#/components/schemas/EventDeleted"

  schemas:
    EventHeaders:
      type: object
      properties:
        event-type:
          type: string
          description: Routing key of the event
          example: event.published
        producer:
          type: string
          example: events-service
        schema:
          type: string
          example: "1"
      required:
        - event-type

    EventPublished:
      type: object
      properties:
        eventId:
          type: string
        creatorId:
          type: string
        collaboratorIds:
          type: array
          items:
            type: string
      required:
        - eventId
        - creatorId

    EventUpdated:
      type: object
      properties:
        eventId:
          type: string
        collaboratorIds:
          type: array
          items:
            type: string
      required:
        - eventId

    EventDeleted:
      type: object
      properties:
        eventId:
          type: string
      required:
        - eventId